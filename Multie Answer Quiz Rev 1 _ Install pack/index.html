<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>CSV Quiz</title><meta name="theme-color" content="#6d28d9"><link rel="manifest" href="manifest.json"><link rel="icon" sizes="192x192" href="icon-192.png"><link rel="apple-touch-icon" href="icon-192.png"><style>:root{--bg:#f7f7fb;--card:#fff;--text:#0f172a;--muted:#6b7280;--brand:#6d28d9;--blue:#2563eb;--ring:#e5e7eb}*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}.wrap{max-width:1000px;margin:18px auto;padding:0 14px}h1{margin:0 0 8px 0;font-weight:700}.badge{font-size:12px;background:#f3f4f6;border-radius:999px;padding:5px 10px;color:#374151}.toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}button{border:0;border-radius:10px;padding:10px 14px;background:#e5e7eb;cursor:pointer}.blue{background:var(--blue);color:#fff}.dark{background:#374151;color:#fff}.card{background:var(--card);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04),0 8px 30px rgba(0,0,0,.06);padding:16px}#status{color:#6b7280;margin:6px 0}#warning{color:#b91c1c;margin:6px 0}#quiz{display:none}.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.spacer{flex:1}.opt{background:#f9fafb;border:1px solid var(--ring);border-radius:12px;padding:12px;margin:10px 0;user-select:none}.opt.disabled{opacity:.75;pointer-events:none}.opt.correct{background:#ecfdf5;border-color:#34d399}.opt.incorrect{background:#fef2f2;border-color:#fca5a5}.opt.correct-faint{outline:1px dashed #34d399}.opt.selected{outline:2px solid var(--blue)}.muted{color:#6b7280;font-size:12px}.progress{height:10px;border-radius:999px;background:#e5e7eb;position:relative}.bar{position:absolute;top:0;left:0;height:100%;width:0;background:var(--blue)}#submitMulti{display:none;margin-top:6px}</style></head><body><div class="wrap"><h1>CSV Quiz <span class="badge">Installable • Offline</span></h1><div class="toolbar"><input type="file" id="file" accept=".csv,text/csv"><button id="shuffleQs" class="blue">Shuffle Questions</button><button id="reset" class="blue">Reset Progress</button><button id="hard" class="dark">Hard Reset</button></div><div id="status" class="muted">Load a CSV to begin. (Progress autosaves offline.)</div><div id="warning"></div><div id="quiz" class="card"><div class="row" style="margin-bottom:6px;"><div id="chapter" class="badge"></div><div class="spacer"></div><div id="pos" class="badge"></div></div><div id="hint" class="muted" style="margin:0 0 6px 0;"></div><div id="question"></div><div id="options"></div><button id="submitMulti" class="blue">Submit answers</button><div id="feedback" style="display:none;margin-top:8px;padding:10px;border:1px solid #eee;border-radius:12px;"></div><div class="row" style="margin-top:8px;"><button id="prev">◀ Prev</button><button id="next">Next ▶</button><div class="spacer"></div><span id="pct" class="muted">0%</span></div><div class="progress" style="margin-top:8px;"><div class="bar" id="bar"></div></div></div></div><script>if('serviceWorker'in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('sw.js').catch(()=>{})})}const STORE='csvquiz:pwa:v1';const DATA_KEY=STORE+':csv';const STATE_KEY=STORE+':state';let allQuestions=[],order=[],answers=[],idx=0,currentFileName='';function shuffle(a){for(let i=a.length-1;i>0;i--){const j=(Math.random()*(i+1))|0;[a[i],a[j]]=[a[j],a[i]]}return a}function invertPerm(p){const inv=[];p.forEach((v,i)=>inv[v]=i);return inv}function fix(s){if(s==null)return'';let t=String(s);t=t.replace(/\u00C2/g,'').replace(/\u00A0/g,' ').replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"');t=t.replace(/\u2013|\u2014/g,'-');t=t.replace(/\s+/g,' ').trim();return t}function norm(s){return fix(s).toLowerCase()}function parseCSV(text){const out=[];let row=[],field='',q=false;for(let i=0;i<text.length;i++){const c=text[i];if(q){if(c=='"'){if(text[i+1]=='"'){field+='"';i++}else q=false}else field+=c}else{if(c=='"')q=true;else if(c==','){row.push(field);field=''}else if(c=='\n'){row.push(field);out.push(row);row=[];field=''}else if(c=='\r'){}else field+=c}}row.push(field);out.push(row);const headers=out.shift().map(h=>h.trim());return out.filter(r=>r.some(x=>x&&String(x).trim().length)).map(r=>{const o={};headers.forEach((h,i)=>o[h]=r[i]??'');return o})}function readCorrect(row){const k=Object.keys(row).reduce((m,k)=>(m[k.toLowerCase().trim()]=k,m),{});return row[k['correct']]??row[k['correct ']]??row[k['answer']]??row[k['key']]??''}function readCorrect2(row){const k=Object.keys(row).reduce((m,k)=>(m[k.toLowerCase().trim()]=k,m),{});return row[k['correct2']]??row[k['correct 2']]??row[k['answer2']]??row[k['key2']]??''}function getExps(row,n){const keys=Object.keys(row);const map=new Map(keys.map(k=>[k.toLowerCase().trim(),k]));function pick(names){for(const name of names){const real=map.get(name.toLowerCase());if(real)return fix(row[real]||'')}return''}let e=[pick(['explanation a','explanationa','exp a','expa','explanation_a']),pick(['explanation b','explanationb','exp b','expb','explanation_b']),pick(['explanation c','explanationc','exp c','expc','explanation_c']),pick(['explanation d','explanationd','exp d','expd','explanation_d'])];if(e.every(x=>!x)){const generic=keys.filter(k=>k.toLowerCase().startsWith('explanation'));e=generic.slice(0,n).map(k=>fix(row[k]||''))}while(e.length<n)e.push('');return e.slice(0,n)}function resolveIndex(raw,opts){raw=fix(raw);if(!raw)return-1;const m=raw.match(/^[A-E]$/i);if(m)return'ABCDE'.indexOf(m[0].toUpperCase());const want=norm(raw);for(let i=0;i<opts.length;i++)if(norm(opts[i])===want)return i;for(let i=0;i<opts.length;i++)if(want&&norm(opts[i]).includes(want))return i;return-1}function buildQuestions(rows){return rows.map(r=>{const choices=['A','B','C','D','E'].map(L=>{const low=L.toLowerCase();const val=(r[L]!=null?r[L]:(r[low]!=null?r[low]:''));return{label:L,text:fix(String(val))}}).filter(o=>o.text.length);const optionTexts=choices.map(c=>c.text);const i1=resolveIndex(readCorrect(r),optionTexts),i2=resolveIndex(readCorrect2(r),optionTexts);const origIdxes=[];if(i1>=0)origIdxes.push(i1);if(i2>=0&&i2!=i1)origIdxes.push(i2);const perm=shuffle([...Array(choices.length).keys()]);const inv=invertPerm(perm);const options=perm.map(i=>choices[i].text);const correctIdxes=origIdxes.map(i=>perm.indexOf(i)).filter(i=>i>=0);return{chapter:fix(r.chapter||r.Chapter||''),question:fix(r.question||r.Question||''),options,originalOptions:optionTexts,perm,inv,exps:getExps(r,choices.length),originalCorrectIdx:(origIdxes[0]??-1),correctIdx:(correctIdxes[0]??-1),correctIdxes,requiredCount:(correctIdxes.length||1)}}).filter(q=>q.question&&q.options.length)}function saveState(){try{const state={idx,order,answers,fileName:currentFileName};localStorage.setItem(STATE_KEY,JSON.stringify(state))}catch(_){}}function saveCSVText(name,text){try{localStorage.setItem(DATA_KEY,JSON.stringify({name,text}))}catch(_){}}function tryResume(){try{const rawCSV=localStorage.getItem(DATA_KEY);const rawState=localStorage.getItem(STATE_KEY);if(!rawCSV||!rawState)return false;const {name,text}=JSON.parse(rawCSV);const st=JSON.parse(rawState);const rows=parseCSV(text);allQuestions=buildQuestions(rows);order=Array.isArray(st.order)&&st.order.every(n=>typeof n==='number')?st.order.filter(i=>i>=0&&i<allQuestions.length):[...Array(allQuestions.length).keys()];answers=Array.isArray(st.answers)?st.answers.slice(0,order.length):Array(order.length).fill(undefined);idx=Math.min(Math.max(0,st.idx|0),Math.max(0,order.length-1));currentFileName=name||'Saved CSV';document.getElementById('status').textContent=`Resumed from "${currentFileName}".`;document.getElementById('quiz').style.display='block';render();return true}catch(e){console.warn('resume failed',e);return false}}function updateProgress(){const p=Math.round(100*(answers.filter(a=>a!==undefined).length)/(order.length||1));document.getElementById('pct').textContent=p+'%';document.getElementById('bar').style.width=p+'%';saveState()}function render(){const has=order.length>0;const qwrap=document.getElementById('quiz');qwrap.style.display=has?'block':'none';if(!has){updateProgress();return}const q=allQuestions[order[idx]];document.getElementById('chapter').textContent=q.chapter||'—';document.getElementById('pos').textContent=`${idx+1} / ${order.length}`;document.getElementById('question').textContent=q.question;const need=q.requiredCount||1;document.getElementById('hint').textContent=(need>1?`Select ${need} answers`:'' );const opts=document.getElementById('options');opts.innerHTML='';const btnSubmit=document.getElementById('submitMulti');btnSubmit.style.display=(need>1&&answers[idx]===undefined)?'inline-block':'none';btnSubmit.disabled=true;const fb=document.getElementById('feedback');fb.style.display='none';fb.innerHTML='';q.options.forEach((txt,i)=>{const div=document.createElement('div');div.className='opt option';div.innerHTML=`${String.fromCharCode(65+i)}) ${txt}`;if(answers[idx]!==undefined){div.classList.add('disabled');if(need===1){if(i===q.correctIdx)div.classList.add('correct');if(i===answers[idx]&&i!==q.correctIdx)div.classList.add('incorrect')}else{const sel=Array.isArray(answers[idx])?answers[idx]:[answers[idx]];const set=new Set(q.correctIdxes);if(sel.includes(i)&&set.has(i))div.classList.add('correct');else if(sel.includes(i)&&!set.has(i))div.classList.add('incorrect');else if(set.has(i))div.classList.add('correct-faint')}}else{if(need===1){div.onclick=()=>gradeSingle(i)}else{div.onclick=()=>toggleMulti(i)}}opts.appendChild(div)});function gradeSingle(i){answers[idx]=i;document.querySelectorAll('#options .option').forEach((el,j)=>{el.classList.add('disabled');if(j===q.correctIdx)el.classList.add('correct');if(j===i&&i!==q.correctIdx)el.classList.add('incorrect')});if(q.exps){const origChosen=(q.perm&&q.perm[i]!=null)?q.perm[i]:i;const expChosen=q.exps[origChosen]||'';const expCorrect=(q.originalCorrectIdx>=0)?(q.exps[q.originalCorrectIdx]||''):'';let out='';if(expChosen)out+=`<div><strong>Your choice:</strong> ${expChosen}</div>`;if(q.correctIdx>=0&&i!==q.correctIdx&&expCorrect)out+=`<div style="margin-top:6px;"><strong>Correct answer note:</strong> ${expCorrect}</div>`;fb.innerHTML=out;fb.style.display=out?'block':'none'}updateProgress()}function toggleMulti(i){const items=[...document.querySelectorAll('#options .option')];if(items[i].classList.contains('selected')){items[i].classList.remove('selected')}else{const selected=items.filter(el=>el.classList.contains('selected')).length;if(selected>=need){for(const el of items){if(el.classList.contains('selected')){el.classList.remove('selected');break}}}items[i].classList.add('selected')}const selectedNow=items.filter(el=>el.classList.contains('selected')).map((el,idx2)=>idx2);btnSubmit.disabled=(selectedNow.length!==need)}btnSubmit.onclick=()=>{const items=[...document.querySelectorAll('#options .option')];const sel=items.map((el,i)=>el.classList.contains('selected')?i:-1).filter(i=>i>=0).sort((a,b)=>a-b);if(sel.length!==need)return;answers[idx]=sel.slice();const set=new Set(q.correctIdxes);items.forEach((el,j)=>{el.classList.add('disabled');if(sel.includes(j)&&set.has(j))el.classList.add('correct');else if(sel.includes(j)&&!set.has(j))el.classList.add('incorrect');else if(set.has(j))el.classList.add('correct-faint');el.classList.remove('selected')});let out='';if(q.exps){sel.forEach(ch=>{const orig=(q.perm&&q.perm[ch]!=null)?q.perm[ch]:ch;const e=q.exps[orig]||'';if(e)out+=`<div><strong>Your choice (${String.fromCharCode(65+ch)}):</strong> ${e}</div>`});const missing=q.correctIdxes.filter(c=>!sel.includes(c));missing.forEach(c=>{const orig=(q.perm&&q.perm[c]!=null)?q.perm[c]:c;const e=q.exps[orig]||'';out+=`<div style="margin-top:6px;"><strong>Correct (${String.fromCharCode(65+c)}):</strong> ${e||'(no note)'}</div>`})}fb.innerHTML=out;fb.style.display=out?'block':'none';btnSubmit.style.display='none';updateProgress()}}document.getElementById('prev').onclick=()=>{if(idx>0){idx--;render();saveState()}};document.getElementById('next').onclick=()=>{if(idx<order.length-1){idx++;render();saveState()}};document.getElementById('reset').onclick=()=>{answers=Array(order.length).fill(undefined);idx=0;render();saveState()};document.getElementById('hard').onclick=()=>{localStorage.removeItem(DATA_KEY);localStorage.removeItem(STATE_KEY);location.reload()};document.getElementById('shuffleQs').onclick=()=>{order=shuffle([...order]);answers=Array(order.length).fill(undefined);idx=0;render();saveState()};document.getElementById('file').onchange=async(e)=>{try{const f=e.target.files[0];if(!f)return;const text=await f.text();saveCSVText(f.name,text);const rows=parseCSV(text);allQuestions=buildQuestions(rows);order=[...Array(allQuestions.length).keys()];answers=Array(order.length).fill(undefined);idx=0;currentFileName=f.name;document.getElementById('status').textContent=`Loaded ${allQuestions.length} questions from "${f.name}".`;document.getElementById('quiz').style.display='block';render();saveState()}catch(err){document.getElementById('warning').textContent='Error loading CSV: '+(err&&err.message?err.message:err)}};if(!tryResume()){document.getElementById('status').textContent='Load a CSV to begin. (Progress autosaves offline.)'}</script></body></html>