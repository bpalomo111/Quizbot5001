<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CSV Quiz â€” Multiâ€‘Answer Edition</title>
<style>
  :root{
    --bg:#f7f7fb; --card:#ffffff; --text:#0f172a;
    --muted:#6b7280; --brand:#6d28d9; --brand-2:#4f46e5;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    --ring:#d1d5db;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  h1{font-size:28px;margin:16px 0 8px 0}
  .wrap{max-width:1000px;margin:14px auto;padding:0 14px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0 10px 0}
  button{background:#e5e7eb;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  button.primary{background:var(--brand);color:#fff}
  button.blue{background:#2563eb;color:#fff}
  button.dark{background:#374151;color:#fff}
  .card{background:var(--card);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04),0 8px 30px rgba(0,0,0,.06);padding:16px}
  #status{margin:6px 0 10px 0;color:var(--muted)}
  #warning{color:#b91c1c;margin:6px 0 10px 0}
  .badge{background:#f3f4f6;border-radius:999px;padding:4px 10px;font-size:12px;color:#374151}
  #meta{display:flex;gap:10px;align-items:center;justify-content:flex-end}
  #question{font-size:20px;margin:10px 0 14px 0}
  .opt{background:#f9fafb;border:1px solid var(--ring);border-radius:12px;padding:14px;margin:10px 0;cursor:pointer;user-select:none}
  .opt.disabled{pointer-events:none;opacity:.75}
  .opt.correct{background:#ecfdf5;border-color:#34d399}
  .opt.incorrect{background:#fef2f2;border-color:#fca5a5}
  .opt.correct-faint{outline:1px dashed #34d399}
  .opt.selected{outline:2px solid var(--brand-2)}
  #feedback{display:none;margin-top:10px;padding:10px;border:1px solid #eee;border-radius:12px;background:#fff}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .spacer{flex:1}
  .progress{height:10px;border-radius:999px;background:#e5e7eb;position:relative;overflow:hidden}
  .bar{position:absolute;top:0;left:0;height:100%;width:0;background:var(--brand-2)}
  #pct{font-size:12px;color:#6b7280}
  /* chips */
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #ddd;border-radius:999px;background:#fff;font-size:12px}
  .chip.green{background:#ecfdf5;color:#065f46;border-color:#34d399}
  .chip.yellow{background:#fffbeb;color:#92400e;border-color:#fcd34d}
  .chip.red{background:#fef2f2;color:#991b1b;border-color:#fca5a5}
  .chkchip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #ddd;border-radius:999px;background:#fff}
  .chkchip input{transform:scale(1.15)}
  .muted{color:var(--muted);font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>CSV Quiz <span class="badge">Multiâ€‘Answer</span></h1>
    <div class="toolbar">
      <input type="file" id="file" accept=".csv,text/csv">
      <button id="shuffleBoth" class="primary">New Shuffle (Qs+Answers)</button>
      <button id="shuffleQs" class="blue">Shuffle Questions</button>
      <button id="reset" class="blue">Reset Progress</button>
      <button id="toggleFilter" class="blue">Filter</button>
      <button id="hard" class="dark">Hard Reset</button>
    </div>

    <div id="status" class="muted">Load a CSV to begin.</div>
    <div id="warning"></div>

    <!-- Filter Panel -->
    <section id="filterPanel" class="card" style="display:none;">
      <div class="row">
        <h3 style="margin:0;">Filter by Chapter</h3>
        <div class="spacer"></div>
        <button id="filterSelectAll">Select All</button>
        <button id="filterClear">Clear</button>
        <button id="filterApply" class="primary">Apply Filter</button>
      </div>
      <div id="filterChips" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;"></div>
      <div id="filterNote" class="muted" style="margin-top:6px;"></div>
    </section>

    <div id="quiz" class="card" style="margin-top:12px;display:none;">
      <div class="row" style="margin-bottom:6px;">
        <div id="chapter" class="badge"></div>
        <div class="spacer"></div>
        <div id="pos" class="badge"></div>
      </div>
      <div id="hint" class="muted" style="margin:0 0 6px 0;"></div>
      <div id="question"></div>
      <div id="options"></div>
      <div id="feedback"></div>
      <div class="row" style="margin-top:8px;">
        <button id="prev">â—€ Prev</button>
        <button id="next">Next â–¶</button>
        <div class="spacer"></div>
        <span id="pct">0%</span>
      </div>
      <div class="progress" style="margin-top:8px;"><div class="bar" id="bar"></div></div>
    </div>

    <!-- Completion Card -->
    <section id="completeCard" class="card" style="display:none;margin-top:12px;">
      <h3 style="margin:0 0 8px 0;">All done ðŸŽ‰</h3>
      <div id="completeSummary" style="margin-bottom:10px;"></div>
      <div class="row">
        <button id="btnReviewWrong">Review Wrong Only</button>
        <button id="btnRestart" class="primary">Restart</button>
      </div>
    </section>

    <!-- Chapter Results Footer -->
    <section id="resultsFooter" class="card" style="display:none;margin-top:12px;">
      <div id="chapterChips" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
    </section>

  </div>

<script>
// ---------- State ----------
let allQuestions = [];      // full question objects
let order = [];             // indices into allQuestions
let answers = [];           // per-order position: number or [numbers]
let idx = 0;
let currentFileName = '';
const STORAGE = 'csvquiz_multi_v1';

// ---------- Utils & CSV ----------
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function invertPerm(perm){ const inv=[]; perm.forEach((p,i)=>inv[p]=i); return inv; }
function fixEncodingArtifacts(s){
  if(s==null) return '';
  let t=String(s);
  t=t.replace(/\u00C2/g,'');
  t=t.replace(/\u00A0/g,' ');
  t=t.replace(/[\u2018\u2019]/g,"'");
  t=t.replace(/[\u201C\u201D]/g,'"');
  t=t.replace(/\u2013|\u2014/g,'-');
  t=t.replace(/\s+/g,' ').trim();
  return t;
}
function normalizeText(s){ return fixEncodingArtifacts(s).toLowerCase(); }

// Small CSV parser (handles quotes, commas, newlines)
function parseCSV(text){
  const out=[]; let row=[]; let field=''; let q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(q){
      if(c=='"'){
        if(text[i+1]=='"'){ field+='"'; i++; }
        else q=false;
      }else field+=c;
    }else{
      if(c=='"') q=true;
      else if(c==','){ row.push(field); field=''; }
      else if(c=='\n'){ row.push(field); out.push(row); row=[]; field=''; }
      else if(c=='\r'){ /* ignore */ }
      else field+=c;
    }
  }
  row.push(field); out.push(row);
  const headers = out.shift().map(h=>h.trim());
  return out.filter(r=>r.some(x=>x && String(x).trim().length)).map(r=>{
    const o={}; headers.forEach((h,i)=>o[h]=r[i]??''); return o;
  });
}

// ---------- Explanations & corrects ----------
function readCorrect(row){
  const k = Object.keys(row).reduce((m,k)=> (m[ k.toLowerCase().trim() ] = k, m), {});
  return row[k['correct']] ?? row[k['answer']] ?? row[k['key']] ?? row[k['correct ']] ?? '';
}
function readCorrect2(row){
  const k = Object.keys(row).reduce((m,k)=> (m[ k.toLowerCase().trim() ] = k, m), {});
  return row[k['correct2']] ?? row[k['correct 2']] ?? row[k['answer2']] ?? row[k['key2']] ?? '';
}

function getOptionExplanations(row, n){
  const keys = Object.keys(row);
  const map = new Map(keys.map(k=>[k.toLowerCase().trim(), k]));
  function pick(names){ for(const name of names){ const real=map.get(name.toLowerCase()); if(real) return fixEncodingArtifacts(row[real]||''); } return ''; }
  let exps = [
    pick(['explanation a','explanationa','exp a','expa','explanation_a']),
    pick(['explanation b','explanationb','exp b','expb','explanation_b']),
    pick(['explanation c','explanationc','exp c','expc','explanation_c']),
    pick(['explanation d','explanationd','exp d','expd','explanation_d'])
  ];
  if(exps.every(x=>!x)){
    const generic = keys.filter(k=>k.toLowerCase().startsWith('explanation'));
    exps = generic.slice(0,n).map(k=>fixEncodingArtifacts(row[k]||''));
  }
  while(exps.length<n) exps.push('');
  return exps.slice(0,n);
}

function resolveCorrectIndexFromRow(row, optionTexts){
  const raw = (readCorrect(row)||'').toString().trim();
  const m = raw.match(/^[A-E]$/i);
  if(m) return 'ABCDE'.indexOf(m[0].toUpperCase());
  const norm = normalizeText(raw);
  for(let i=0;i<optionTexts.length;i++) if(normalizeText(optionTexts[i])===norm) return i;
  for(let i=0;i<optionTexts.length;i++) if(norm && normalizeText(optionTexts[i]).includes(norm)) return i;
  return -1;
}
function resolveCorrectIndices(row, optionTexts){
  const i1 = resolveCorrectIndexFromRow(row, optionTexts);
  const raw2 = (readCorrect2(row)||'').toString().trim();
  let i2 = -1;
  if(raw2){
    const m = raw2.match(/^[A-E]$/i);
    if(m) i2 = 'ABCDE'.indexOf(m[0].toUpperCase());
    if(i2<0){
      const norm = normalizeText(raw2);
      for(let i=0;i<optionTexts.length;i++) if(normalizeText(optionTexts[i])===norm){ i2=i; break; }
      if(i2<0) for(let i=0;i<optionTexts.length;i++) if(norm && normalizeText(optionTexts[i]).includes(norm)){ i2=i; break; }
    }
  }
  const arr=[]; if(i1>=0) arr.push(i1); if(i2>=0 && i2!==i1) arr.push(i2);
  return arr;
}
function isAnswerCorrect(q, ans){
  if(ans===undefined) return false;
  if(Array.isArray(q.correctIdxes)){
    const need = q.correctIdxes.slice().sort((a,b)=>a-b);
    const got = (Array.isArray(ans)?ans:[ans]).slice().sort((a,b)=>a-b);
    if(need.length!==got.length) return false;
    for(let i=0;i<need.length;i++) if(need[i]!==got[i]) return false;
    return true;
  }
  return (q.correctIdx>=0 && ans===q.correctIdx);
}

// ---------- Build questions ----------
function buildQuestions(rows){
  return rows.map(r => {
    const choices = ['A','B','C','D','E'].map(L => ({
      label:L, text: fixEncodingArtifacts((r[L]??r[L?.toLowerCase?.()]??'').toString())
    })).filter(o=>o.text.length);

    const optionTexts = choices.map(c=>c.text);
    const origIdxes = resolveCorrectIndices(r, optionTexts); // 1 or 2

    const perm = shuffle([...Array(choices.length).keys()]);
    const inv = invertPerm(perm);
    const options = perm.map(i=>choices[i].text);
    const correctIdxes = origIdxes.map(i=>perm.indexOf(i)).filter(i=>i>=0);

    return {
      chapter: fixEncodingArtifacts(r.chapter || r.Chapter || ''),
      question: fixEncodingArtifacts(r.question || r.Question || ''),
      options,
      originalOptions: optionTexts,
      perm, inv,
      exps: getOptionExplanations(r, choices.length),
      // single-answer legacy fields
      originalCorrectIdx: origIdxes[0] ?? -1,
      correctIdx: correctIdxes[0] ?? -1,
      // multi-answer
      correctIdxes,
      requiredCount: correctIdxes.length || 1
    };
  }).filter(q => q.question && q.options.length);
}

// ---------- Render ----------
function updateProgress(){
  const p = Math.round(100 * (answers.filter(a=>a!==undefined).length) / (order.length||1));
  document.getElementById('pct').textContent = (order.length? p:0) + '%';
  document.getElementById('bar').style.width = p + '%';
}
function computeChapterStats(){
  const stats = new Map();
  order.forEach((qIdx, pos) => {
    const q = allQuestions[qIdx];
    const ch = q.chapter || 'â€”';
    if(!stats.has(ch)) stats.set(ch, {correct:0,total:0});
    const s = stats.get(ch);
    s.total += 1;
    if(isAnswerCorrect(q, answers[pos])) s.correct += 1;
  });
  return stats;
}
function classForPct(p){ if(p>=90) return 'green'; if(p>=50) return 'yellow'; return 'red'; }
function renderChapterChips(){
  const footer = document.getElementById('resultsFooter');
  const wrap = document.getElementById('chapterChips');
  if(!footer||!wrap){ return; }
  if(!order.length){ footer.style.display='none'; return; }
  const stats = computeChapterStats();
  wrap.innerHTML='';
  [...stats.keys()].sort((a,b)=>(a||'').localeCompare(b||'')).forEach(ch => {
    const {correct,total} = stats.get(ch);
    const p = total? Math.round(100*correct/total) : 0;
    const el = document.createElement('span');
    el.className = 'chip ' + classForPct(p);
    el.innerHTML = `<strong>${ch}</strong> ${correct}/${total} (${p}%)`;
    wrap.appendChild(el);
  });
  footer.style.display='block';
}
function maybeShowCompleteCard(){
  const card = document.getElementById('completeCard');
  const sum = document.getElementById('completeSummary');
  if(!card||!sum) return;
  const done = answers.filter(a=>a!==undefined).length === order.length && order.length>0;
  if(!done){ card.style.display='none'; return; }
  let c=0; order.forEach((qIdx,pos)=>{ if(isAnswerCorrect(allQuestions[qIdx], answers[pos])) c++; });
  const p = Math.round(100 * c / order.length);
  sum.textContent = `You answered ${c} out of ${order.length} correctly (${p}%).`;
  card.style.display='block';
}

function render(){
  const has = order.length>0;
  document.getElementById('quiz').style.display = has? 'block':'none';
  if(!has){ updateProgress(); renderChapterChips(); return; }

  const q = allQuestions[order[idx]];
  document.getElementById('chapter').textContent = q.chapter || 'â€”';
  document.getElementById('pos').textContent = `${idx+1} / ${order.length}`;
  document.getElementById('question').textContent = q.question;
  const need = q.requiredCount || 1;
  document.getElementById('hint').textContent = (need>1? `Select ${need} answers` : '');

  const opts = document.getElementById('options'); opts.innerHTML='';
  q.options.forEach((txt, i) => {
    const div = document.createElement('div');
    div.className = 'opt option';
    div.textContent = `${String.fromCharCode(65+i)}) ${txt}`;
    div.onclick = () => choose(i);
    opts.appendChild(div);
  });

  // if already answered, style it
  const a = answers[idx];
  if(a !== undefined){
    if(need===1){
      const i = a;
      document.querySelectorAll('#options .option').forEach((el, j) => {
        el.classList.add('disabled');
        if(j===q.correctIdx) el.classList.add('correct');
        if(j===i && i!==q.correctIdx) el.classList.add('incorrect');
      });
    }else{
      const sel = Array.isArray(a) ? a : [a];
      const needSet = new Set(q.correctIdxes);
      document.querySelectorAll('#options .option').forEach((el, j) => {
        el.classList.add('disabled');
        if(sel.includes(j) && needSet.has(j)) el.classList.add('correct');
        else if(sel.includes(j) && !needSet.has(j)) el.classList.add('incorrect');
        else if(needSet.has(j)) el.classList.add('correct-faint');
      });
    }
  }else{
    const fbEl=document.getElementById('feedback'); if(fbEl) fbEl.style.display='none';
  }

  updateProgress();
  renderChapterChips();
  maybeShowCompleteCard();
}

// ---------- Interactions ----------
window._multiSel = {};

function choose(i){
  const q = allQuestions[order[idx]];
  const need = q.requiredCount || 1;

  if(answers[idx] !== undefined) return;

  if(need === 1){
    answers[idx] = i;
    document.querySelectorAll('#options .option').forEach((el, j) => {
      el.classList.add('disabled');
      if(j===q.correctIdx) el.classList.add('correct');
      if(j===i && i!==q.correctIdx) el.classList.add('incorrect');
    });
    const fb = document.getElementById('feedback');
    if(fb && q && q.exps){
      const origChosen = (q.perm && q.perm[i] !== undefined) ? q.perm[i] : i;
      const expChosen = q.exps[origChosen] || '';
      const expCorrect = (q.originalCorrectIdx>=0) ? (q.exps[q.originalCorrectIdx] || '') : '';
      let out='';
      if(expChosen) out += `<div><strong>Your choice:</strong> ${expChosen}</div>`;
      if(q.correctIdx>=0 && i!==q.correctIdx && expCorrect) out += `<div style="margin-top:6px;"><strong>Correct answer note:</strong> ${expCorrect}</div>`;
      if(out){ fb.innerHTML=out; fb.style.display='block'; } else fb.style.display='none';
    }
    updateProgress(); renderChapterChips(); maybeShowCompleteCard();
    return;
  }

  // multi
  const key = String(order[idx]);
  const sel = (_multiSel[key] = (_multiSel[key] || []));
  const p = sel.indexOf(i);
  if(p>=0) sel.splice(p,1); else sel.push(i);

  document.querySelectorAll('#options .option').forEach((el, j) => {
    if(sel.includes(j)) el.classList.add('selected'); else el.classList.remove('selected');
  });
  if(sel.length < need) return;

  sel.sort((a,b)=>a-b);
  answers[idx] = sel.slice();

  const needSet = new Set(q.correctIdxes);
  document.querySelectorAll('#options .option').forEach((el, j) => {
    el.classList.remove('selected');
    el.classList.add('disabled');
    if(sel.includes(j) && needSet.has(j)) el.classList.add('correct');
    else if(sel.includes(j) && !needSet.has(j)) el.classList.add('incorrect');
    else if(needSet.has(j)) el.classList.add('correct-faint');
  });

  const fb = document.getElementById('feedback');
  let out='';
  if(q.exps){
    sel.forEach(ch => {
      const orig = (q.perm && q.perm[ch] !== undefined) ? q.perm[ch] : ch;
      const e = q.exps[orig] || '';
      if(e) out += `<div><strong>Your choice (${String.fromCharCode(65+ch)}):</strong> ${e}</div>`;
    });
    const missing = q.correctIdxes.filter(c => !sel.includes(c));
    if(missing.length){
      missing.forEach(c => {
        const orig = (q.perm && q.perm[c] !== undefined) ? q.perm[c] : c;
        const e = q.exps[orig] || '';
        out += `<div style="margin-top:6px;"><strong>Correct (${String.fromCharCode(65+c)}):</strong> ${e || '(no note)'}</div>`;
      });
    }
  }
  if(fb){ fb.innerHTML = out; fb.style.display = out ? 'block' : 'none'; }

  updateProgress(); renderChapterChips(); maybeShowCompleteCard();
}

// ---------- Filter UI ----------
const FILTER_KEY = STORAGE + ':chapters';

function uniqueChapters(list){ const s=new Set(list.map(x=>(x||'').toString())); return Array.from(s).sort((a,b)=>(a||'').localeCompare(b||'')); }
function buildChapterChips(){
  const cont = document.getElementById('filterChips'); if(!cont) return;
  cont.innerHTML='';
  const chapters = uniqueChapters(allQuestions.map(q=>q.chapter||'â€”'));
  let selected = [];
  try{ selected = JSON.parse(localStorage.getItem(FILTER_KEY) || '[]'); }catch(_){}
  if(!selected.length) selected = chapters.slice();
  chapters.forEach(ch => {
    const id = 'chk_' + btoa(unescape(encodeURIComponent(ch))).replace(/=+$/,'');
    const el = document.createElement('label');
    el.className = 'chkchip';
    el.innerHTML = `<input type="checkbox" id="${id}" ${selected.includes(ch)?'checked':''}> <span>${ch}</span>`;
    cont.appendChild(el);
  });
  const note = document.getElementById('filterNote'); if(note) note.textContent = `(${chapters.length} chapters found)`;
}
function getSelectedChapters(){
  return Array.from(document.querySelectorAll('#filterChips input[type="checkbox"]'))
    .filter(cb=>cb.checked).map(cb=>cb.nextElementSibling.textContent);
}
function applyChapterFilter(){
  const sel = getSelectedChapters();
  try{ localStorage.setItem(FILTER_KEY, JSON.stringify(sel)); }catch(_){}
  const newOrder=[];
  allQuestions.forEach((q,i)=>{ const ch=q.chapter||'â€”'; if(!sel.length || sel.includes(ch)) newOrder.push(i); });
  order = newOrder; answers = Array(order.length).fill(undefined); idx=0;
  document.getElementById('status').textContent = `Showing ${order.length} of ${allQuestions.length} questions (filtered).`;
  render(); renderChapterChips(); maybeShowCompleteCard();
}
function initFilter(){
  document.getElementById('toggleFilter').onclick = () => {
    const p = document.getElementById('filterPanel');
    p.style.display = (p.style.display==='none' || !p.style.display) ? 'block' : 'none';
    if(p.style.display==='block') buildChapterChips();
  };
  document.getElementById('filterSelectAll').onclick = () => { buildChapterChips(); document.querySelectorAll('#filterChips input').forEach(cb=>cb.checked=true); };
  document.getElementById('filterClear').onclick = () => { document.querySelectorAll('#filterChips input').forEach(cb=>cb.checked=false); };
  document.getElementById('filterApply').onclick = () => applyChapterFilter();
}

// ---------- Completion actions ----------
document.getElementById('btnRestart').onclick = () => { answers = Array(order.length).fill(undefined); idx=0; render(); renderChapterChips(); maybeShowCompleteCard(); };
document.getElementById('btnReviewWrong').onclick = () => {
  const newOrder=[];
  order.forEach((qIdx,pos)=>{ if(!isAnswerCorrect(allQuestions[qIdx], answers[pos])) newOrder.push(qIdx); });
  order = newOrder; answers = Array(order.length).fill(undefined); idx=0;
  render(); renderChapterChips(); maybeShowCompleteCard();
};

// ---------- Navigation & controls ----------
document.getElementById('prev').onclick = () => { if(idx>0){ idx--; render(); } };
document.getElementById('next').onclick = () => { if(idx<order.length-1){ idx++; render(); } };

document.getElementById('shuffleQs').onclick = () => {
  const prev = order[idx];
  order = shuffle([...order]);
  answers = Array(order.length).fill(undefined);
  idx = 0;
  if(order.length>1 && order[0]===prev) idx = 1;
  render(); renderChapterChips(); maybeShowCompleteCard();
  const fbEl=document.getElementById('feedback'); if(fbEl) fbEl.style.display='none';
};
document.getElementById('shuffleBoth').onclick = () => {
  // rebuild with fresh per-question option permutations
  allQuestions = buildQuestions(allQuestions.map(q => {
    // map current shuffled correctIdxes back to original via inverse permutation
    const inv = q.inv || (function(){ const ii=[]; (q.perm||[]).forEach((p,i)=>ii[p]=i); return ii; })();
    const orig1 = (Array.isArray(q.correctIdxes) && q.correctIdxes.length>=1) ? inv[q.correctIdxes[0]] : (q.originalCorrectIdx>=0 ? q.originalCorrectIdx : -1);
    const orig2 = (Array.isArray(q.correctIdxes) && q.correctIdxes.length>=2) ? inv[q.correctIdxes[1]] : -1;
    return {
      chapter:q.chapter, question:q.question,
      A:q.originalOptions[0]||'', B:q.originalOptions[1]||'',
      C:q.originalOptions[2]||'', D:q.originalOptions[3]||'', E:q.originalOptions[4]||'',
      correct: (orig1>=0? 'ABCDE'[orig1] : ''),
      correct2: (orig2>=0? 'ABCDE'[orig2] : '')
    };
  }));
  order = shuffle([...Array(allQuestions.length).keys()]);
  answers = Array(order.length).fill(undefined); idx=0;
  render(); renderChapterChips(); maybeShowCompleteCard();
  buildChapterChips();
};
document.getElementById('reset').onclick = () => { answers = Array(order.length).fill(undefined); idx=0; render(); renderChapterChips(); maybeShowCompleteCard(); };
document.getElementById('hard').onclick = () => { localStorage.clear(); location.reload(); };

// ---------- File load ----------
document.getElementById('file').onchange = async (e) => {
  const file = e.target.files[0]; if(!file) return;
  currentFileName = file.name;
  const text = await file.text();
  const rows = parseCSV(text);
  const warn = document.getElementById('warning'); warn.textContent = '';

  allQuestions = buildQuestions(rows);
  let bad=0; rows.forEach((r,i)=>{
    const choices=['A','B','C','D','E'].map(L=>(r[L]||'').toString().trim()).filter(x=>x);
    const idxes = resolveCorrectIndices(r, choices);
    if(!idxes.length) bad++;
  });
  if(bad>0) warn.textContent = `âš  ${bad} with missing/invalid correct key`;

  order = [...Array(allQuestions.length).keys()];
  answers = Array(order.length).fill(undefined);
  idx=0;
  document.getElementById('status').textContent = `Loaded ${allQuestions.length} questions from "${file.name}".`;
  document.getElementById('quiz').style.display='block';
  buildChapterChips();
  render();
};

// init
initFilter();
</script>
</body>
</html>
